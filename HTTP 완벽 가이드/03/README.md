# 3장 HTTP 메시지

## 메시지

HTTP 애플리케이션 간에 주고받은 데이터의 블록들

### 용어 정리

- 인바운드: 서버 방향 이동
- 아웃바운드: 사용자 에이전트(user agent) 방향 이동
- 업스트림: 메시지의 발송자
- 다운스트림: 메시지의 수신자
    - 모든 메시지는 다운 스트림으로 흐름

### 메시지 각 부분

- 시작줄
    - 어떤 메시지인가
- 헤더
    - 속성
- 본문
    - 데이터
    - 없을 수도 있음
    - 시작줄이나 헤더와 다르게 이진 데이터를 포함하는 것이 가능

각 줄은 캐리지 리턴(ASCII 13)과 개행문자(ASCII 10)으로 끝난다.(CRLF)
HTTP 명세는 CRLF만 받아들이지만, 견고한 애플리케이션이라면 그냥 개행문자도 받아내야 함

### 메시지 문법

- 요청 메시지
    - ```text
  ＜메서드＞ ＜요청 URL＞ ＜버전＞
  ＜헤더＞

  ＜엔터티 본문＞
    ```
- 응답 메시지
    - ```text
  ＜버전＞ ＜상태코드＞ ＜사유구절＞
  ＜헤더＞

  ＜엔터티 본문＞
    ```
- 메서드: 클라이언트 측에서 서버가 리소스에 대해 수행해주길 바라는 동작(무엇을 해야하는지)
- 요청 URL: 요청 대상이 되는 리소스를 지칭하는 완전한 URL 혹은 URL의 경로 구성요소
- 버전: 사용 중인 HTTP 버전
    - 요청, 응답 시 양쪽 모두에 기술
    - HTTP/<메이저 버전>.<마이너 버전>
        - HTTP/2.22 버전은 HTTP/2.3 버전보다 더 큰(최신) 버전
- 상태 코드: 요청 중에 무엇이 일어났는지 설명하는 세자리 숫자(무엇이 일어났는지)
- 사유 구절: 숫자로 된 상태 코드의 의미를 사람이 이해할 수 있게 설명해주는 짧은 문구
    - 사람에게 읽히도록 만들었을 뿐 상태코드가 같으면 동일한 의미 (200 OK = 200 NOT OK)
- 헤더들: 이름, 콜론, 선택적인 공백, 값, CRLF로 이뤄진 0개 이상의 헤더들(이름/값 쌍 목록)
    - HTTP/1.1과 같은 일부 버전은 특정 헤더를 포함해야 유효하는 것으로 간주함
    - 종류
        - 일반 헤더: 요청, 응답 양쪽에 모두 나타날 수 있음
        - 요청 헤더: 요청에 대한 부가 정보 제공
        - 응답 헤더: 응답에 대한 부가 정보 제공
        - Entity 헤더: 본문 크기, 혹은 리소스 그 자체 서술
        - 확장 헤더: 명세에 없는 새로운 헤더
    - 추가 줄 앞에 최소 하나의 스페이스 또는 탭문자를 쓰면 긴 헤더 줄을 여러 줄로 나눌 수 있음
- 엔티티 본문: 임의 데이터 블록 포함하거나 그냥 CRLF로 끝남
    - 엔터티 본문이 없으면 헤더 집합은 항상 CRLF로 끝나야 하지만, 클라이언트와 서버는 이것이 지켜지지 않아도 받아들일 수 있어야 함
- 시작줄
    - 요청줄(요청 메시지의 시작줄): 메서드, 요청 URL, HTML 버전
    - 응답줄(응답 메시지의 시작줄): HTTP 버전, 상태 코드, 사유 구절
- (참고) 0.9 버전 메시지
    - 매우 단순함(원라인 프로토콜이라고도 불림)
    - HTTP 프로토콜의 초기 버전으로써, 요청 시 버전을 제외한 메서드, 요청 URL만으로 구성
    - 응답 시 엔티티로만 구성(상태 코드, 사유 구절, 헤더 없음)

### 메서드

모든 서버가 모든 메서드를 구현하지는 않는다. HTTP 1.1과 호환되고자 하면 GET, HEAD로 충분함.

- 안전한 메서드: `GET`, `HEAD` 메서드는 요청 결과로 서버에 어떠한 작용도 없음
    - 서버에 작용을 유발하지 않는다는 것을 보장하지는 않음(개발자에게 달림)
    - 서버에 영향을 줄 수 있는(안전하지 않은) 메서드가 사용될 때 그 사실을 사용자들에게 알려줄 수 있도록 하기 위함
    - `GET`: 리소스 달라고 요청할 때 쓰임
    - `HEAD`: 정확히 `GET`처럼 행동. 응답으로 헤더만 돌려줌(본문 없음).
        - 리소스 가져오지 않고 정보, 개체 존재 여부(상태 코드 이용), 리소스 변경 여부 알아낼 수 있음
        - 서버 개발자들은 반환 헤더는 GET과 일치함을 반드시 보장해야 함
    - `PUT`: 요청 본문을 가지고 요청 URL 이름대로 새 문서를 만들거나, 요청 URL 존재 시 교체하는 것(컨텐츠 변경)
    - `POST`: 입력 데이터 전송 목적(HTML form 지원 위함)
    - `TRACE`: 목적지 서버에서 루프백 진단. 요청 전송 마지막 단계 서버가 자기가 받은 요청 메시지를 넣어 TRACE 응답을 되돌려 줌
        - 요청/응답 연쇄를 따라가면서 자신이 보낸 메시지가 망가지거나 수정되었는지 확인(진단 목적)
        - but, 다른 메서드들은 다르게 동작할 수 있다는 것을 고려해야 함
    - `OPTIONS`: 여러 가지 종류의 지원 범위에 대해 질의(메서드 등)
    - `DELETE`: 요청 URL로 지정한 리소스를 삭제 요청
    - 확장 메서드: HTTP/1.1 명세에 정의되지 않은 메서드
        - cf) WebDAV HTTP 확장(19장)

### 상태 코드

- 100-109: 정보성 상태 코드
    - 100 Continue: 서버가 다루거나 사용할 수 없는 큰 엔티티를 서버에 보내지 않으려는 목적으로 사용
        - 100-continue 응답을 받을 것을 의도하지 않은 클라이언트(100-continue Expect 헤더가 없는 요청)에게 보내서는 안 됨
- 200-299: 성공 상태 코드
- 300-399: 리다이렉션 상태 코드
    - 클라이언트가 관심있어 하는 리소스에 대해 다른 위치를 사용하라고 말해주거나 다른 대안 응답 제공
    - Location 헤더에 옮겨진 리소스 위치 제공 가능 -> 브라우저가 알아서 새 위치로 이동
    - 302 FOUND, 303 SEE OTHER, 307 Temporary Redirect 차이
        - 302 FOUND는 POST 요청 응답인 경우에도 POST으로 따라감(HTTP 1.0)
        - 303 SEE OTHER은 POST 요청 응답 시 GET 요청으로 리다이렉션(HTTP 1.1)
        - 307 Temporary Redirect은 POST 요청 응답 시 POST 요청으로 리다이렉션(HTTP 1.1)
- 400-499 클라이언트 에러 상태 코드
    - 서버가 다룰 수 없는 것을 보냈을 때
- 500-599 서버 에러 상태 코드
    - 서버(또는 프록시나 게이트웨이) 자체에서 에러

### 헤더

- 일반 헤더
    - 클라이언트, 서버 양쪽 모두 사용. 기본 정보 제공.
        - Connection
        - Date
        - MIME-Version
        - Trailer Chunked transfer
        - Transfer-Encoding
        - Upgrade
        - Via
    - 일반 캐시 헤더
        - 원서버로부터 객체를 가져오는 대신 로컬 복사본으로 캐시할 수 있도록 함(HTTP/1.0)
            - Cache-Control
            - Pragma
- 요청 헤더
    - 요청 메시지를 위한 헤더. 누가 보냈는지, 클라이언트 선호 포함.
        - Client-IP
        - From
        - Host
        - Referer
        - UA-*(UA-로 시작하는 헤더들)
        - User-Agent
    - Accept 관련 헤더
        - Accept-Charset
        - Accept-Encoding
        - Accept-Language
        - TE(Transfer-Encoding)
    - 조건부 요청 헤더
        - Expect
        - If-Match
        - If-Modified-Since
        - If-Non-Match
        - If-Range
        - If-Unmodified-Since
        - Range
    - 요청 보안 헤더
        - Authorization
        - Cookie
        - Cookie2
    - 프록시 요청 헤더
        - Max-Forwards
        - Proxy-Authorization
        - Proxy-Connection
- 응답 헤더
    - 응답 메시지를 위한 헤더. 누가 응답을 보내고 있는지, 응답자의 능력. ex) Server
        - Age
        - Public
        - Retry-After
        - Server
        - Title
        - Warning
    - 협상 헤더
        - 여러 가지 표현이 가능할 때, 서버와 클라이언트가 어떤 표현을 택할 것인가 하는 협상에 대한 헤더
            - Accept-Ranges
            - Vary
    - 응답 보안 헤더
        - Proxy-Authenticate
        - Set-Cookie
        - Set-Cookie2
        - WWW-Authenticate
- 엔티티 헤더
    - 엔티티 본문에 대한 헤더. 내용물에 대한 것, 개체의 타입, 주어진 리소스에 대해 요철할 수 있는 메서드 등 ex) Content-Type
        - Allow
        - Location
    - 컨텐츠 헤더
        - 컨텐츠에 대한 구체적인 정보 제공
        - Content-Base
        - Content-Encoding
        - Content-Language
        - Content-Length
        - Content-Location
        - Content-MD5
        - Content-Range
        - Content-Type
    - 엔티티 캐싱 헤더
        - 엔티티 캐싱에 대한 정보. 캐시 사본 유효 여부, 캐시 리소스 유효하지 않게 되는 시점 추정 단서 등
            - ETag
            - Expires
            - Last-Modified
- 확장 헤더
    - 애플리케이션 개발자들이 만든, HTTP 명세에 없는 비표준 헤더